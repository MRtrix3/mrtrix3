#!/bin/bash
# Verify operation of "cfe" filter
#   in the scenario where the input data contains NaN values
# Ensure that output matches that generated by a prior software version
#
# Note that the output here is not equivalent to that of default usage
#   just with the NaN-filled fixel excluded,
#   since the value otherwise present in that fixel under default usage
#   contributes to the CFE integration of those fixels to which it is connected
mkdir tmp_fixel
cp SIFT_phantom/fixels/index.mif SIFT_phantom/fixels/directions.mif tmp_fixel
mrcalc SIFT_phantom/fixels/onefixel.mif nan SIFT_phantom/fixels/noise.mif -if tmp_fixel/in.mif
fixelfilter tmp_fixel/in.mif cfe \
    -matrix SIFT_phantom/matrix \
    - | \
testing_diff_image - fixelfilter/cfe/nan.mif -frac 1e-5
