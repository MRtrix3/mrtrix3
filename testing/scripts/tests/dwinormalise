mkdir -p ../tmp/dwinormalise/group && mkdir -p tmp-dwi && mkdir -p tmp-mask && mrconvert BIDS/sub-02/dwi/sub-02_dwi.nii.gz -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval tmp-dwi/sub-02.mif -force && mrconvert BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-mask/sub-02.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_dwi.nii.gz -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval tmp-dwi/sub-03.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-mask/sub-03.mif -force && dwinormalise group tmp-dwi/ tmp-mask/ ../tmp/dwinormalise/group/ ../tmp/dwinormalise/group/fa.mif ../tmp/dwinormalise/group/mask.mif -force && testing_diff_image ../tmp/dwinormalise/group/sub-02.mif dwinormalise/group/sub-02.mif.gz -frac 1e-2 && testing_diff_image ../tmp/dwinormalise/group/sub-03.mif dwinormalise/group/sub-03.mif.gz -frac 1e-2 && testing_diff_image ../tmp/dwinormalise/group/fa.mif dwinormalise/group/fa.mif.gz -abs 1e-3 && testing_diff_image $(mrfilter ../tmp/dwinormalise/group/mask.mif smooth -) $(mrfilter dwinormalise/group/mask.mif.gz smooth -) -abs 0.3
dwinormalise group tmp-dwi/ tmp-mask/ ../tmp/dwinormalise/group/ - ../tmp/dwinormalise/group/mask.mif -force | testing_diff_image - dwinormalise/group/fa.mif.gz -abs 1e-3
dwinormalise group tmp-dwi/ tmp-mask/ ../tmp/dwinormalise/group/ ../tmp/dwinormalise/group/fa.mif - -force | testing_diff_image $(mrfilter - smooth -) $(mrfilter dwinormalise/group/mask.mif.gz smooth -) -abs 0.3
mkdir ../tmp/dwinormalise/manual && dwinormalise manual BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval BIDS/sub-01/dwi/sub-01_brainmask.nii.gz ../tmp/dwinormalise/manual/out.mif -force && testing_diff_image ../tmp/dwinormalise/manual/out.mif dwinormalise/manual/out.mif.gz -frac 1e-5
mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval - | dwinormalise manual - BIDS/sub-01/dwi/sub-01_brainmask.nii.gz - | testing_diff_image - dwinormalise/manual/out.mif.gz -frac 1e-5
mrconvert BIDS/sub-01/dwi/sub-01_brainmask.nii.gz - | dwinormalise manual BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval - ../tmp/dwinormalise/manual/out.mif -force && testing_diff_image ../tmp/dwinormalise/manual/out.mif dwinormalise/manual/out.mif.gz -frac 1e-5
dwinormalise manual BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval BIDS/sub-01/dwi/sub-01_brainmask.nii.gz ../tmp/dwinormalise/manual/percentile.mif -percentile 40 -force && testing_diff_image ../tmp/dwinormalise/manual/percentile.mif dwinormalise/manual/percentile.mif.gz -frac 1e-5
mkdir ../tmp/dwinormalise/mtnorm && dwinormalise mtnorm BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/default_out.mif -scale ../tmp/dwinormalise/mtnorm/default_scale.txt -force && testing_diff_image ../tmp/dwinormalise/mtnorm/default_out.mif dwinormalise/mtnorm/default_out.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwinormalise/mtnorm/default_scale.txt dwinormalise/mtnorm/default_scale.txt -abs 1e-5
mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval - | dwinormalise mtnorm - - | testing_diff_image - dwinormalise/mtnorm/default_out.mif.gz -frac 1e-5
dwinormalise mtnorm BIDS/sub-01/dwi/sub-01_dwi.nii.gz -mask BIDS/sub-01/dwi/sub-01_brainmask.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/masked_out.mif -scale ../tmp/dwinormalise/mtnorm/masked_scale.txt -force && testing_diff_image ../tmp/dwinormalise/mtnorm/masked_out.mif dwinormalise/mtnorm/masked_out.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwinormalise/mtnorm/masked_scale.txt dwinormalise/mtnorm/masked_scale.txt -abs 1e-5
mrconvert BIDS/sub-01/dwi/sub-01_brainmask.nii.gz - | dwinormalise mtnorm BIDS/sub-01/dwi/sub-01_dwi.nii.gz -mask - -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/masked_out.mif -force | testing_diff_image ../tmp/dwinormalise/mtnorm/masked_out.mif dwinormalise/mtnorm/masked_out.mif.gz -frac 1e-5
dwinormalise mtnorm BIDS/sub-01/dwi/sub-01_dwi.nii.gz -lmax 6,0,0 -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/lmax600_out.mif -scale ../tmp/dwinormalise/mtnorm/lmax600_scale.txt -force && testing_diff_image ../tmp/dwinormalise/mtnorm/lmax600_out.mif dwinormalise/mtnorm/lmax600_out.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwinormalise/mtnorm/lmax600_scale.txt dwinormalise/mtnorm/lmax600_scale.txt -abs 1e-5
mrcalc BIDS/sub-01/dwi/sub-01_dwi.nii.gz 1000.0 -div tmp-sub-01_dwi_scaled.mif -force && dwinormalise mtnorm tmp-sub-01_dwi_scaled.mif -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/scaled_out.mif -scale ../tmp/dwinormalise/mtnorm/scaled_scale.txt -force && testing_diff_image ../tmp/dwinormalise/mtnorm/scaled_out.mif dwinormalise/mtnorm/default_out.mif.gz -frac 1e-5
dwinormalise mtnorm BIDS/sub-01/dwi/sub-01_dwi.nii.gz -reference 1.0 -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval ../tmp/dwinormalise/mtnorm/reference_out.mif -scale ../tmp/dwinormalise/mtnorm/reference_scale.txt -force && mrcalc ../tmp/dwinormalise/mtnorm/reference_out.mif 1000.0 -mult - | testing_diff_image - dwinormalise/mtnorm/default_out.mif.gz -frac 1e-5
