mkdir -p ../tmp/population_template && mkdir -p tmp-mask && mkdir -p tmp-fa && mkdir -p tmp-fod && mrconvert BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-mask/sub-02.mif -force && mrconvert BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-mask/sub-03.mif -force && dwi2tensor BIDS/sub-02/dwi/sub-02_dwi.nii.gz -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval -mask BIDS/sub-02/dwi/sub-02_brainmask.nii.gz - | tensor2metric - -fa tmp-fa/sub-02.mif -force && dwi2tensor BIDS/sub-03/dwi/sub-03_dwi.nii.gz -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval -mask BIDS/sub-03/dwi/sub-03_brainmask.nii.gz - | tensor2metric - -fa tmp-fa/sub-03.mif -force && population_template tmp-fa ../tmp/population_template/fa_default_template.mif -warp_dir ../tmp/population_template/fa_default_warpdir/ -transformed_dir ../tmp/population_template/fa_default_transformeddir/ -linear_transformations_dir ../tmp/population_template/fa_default_lineartransformsdir/ -force && testing_diff_image ../tmp/population_template/fa_default_template.mif population_template/fa_default_template.mif.gz -abs 0.01
population_template tmp-fa/ ../tmp/population_template/fa_masked_template.mif -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_masked_mask.mif -force && testing_diff_image ../tmp/population_template/fa_masked_template.mif population_template/fa_masked_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_masked_mask.mif smooth -) $(mrfilter population_template/fa_masked_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_rigid_template.mif -type rigid -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_rigid_mask.mif -force && testing_diff_image ../tmp/population_template/fa_rigid_template.mif population_template/fa_rigid_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_rigid_mask.mif smooth -) $(mrfilter population_template/fa_rigid_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_affine_template.mif -type affine -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_affine_mask.mif -force && testing_diff_image ../tmp/population_template/fa_affine_template.mif population_template/fa_affine_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_affine_mask.mif smooth -) $(mrfilter population_template/fa_affine_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_nonlinear_template.mif -type nonlinear -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_nonlinear_mask.mif -force && testing_diff_image ../tmp/population_template/fa_nonlinear_template.mif population_template/fa_nonlinear_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_nonlinear_mask.mif smooth -) $(mrfilter population_template/fa_nonlinear_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_rigidaffine_template.mif -type rigid_affine -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_rigidaffine_mask.mif -force && testing_diff_image ../tmp/population_template/fa_rigidaffine_template.mif population_template/fa_rigidaffine_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_rigidaffine_mask.mif smooth -) $(mrfilter population_template/fa_rigidaffine_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_rigidnonlinear_template.mif -type rigid_nonlinear -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_rigidnonlinear_mask.mif -force && testing_diff_image ../tmp/population_template/fa_rigidnonlinear_template.mif population_template/fa_rigidnonlinear_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_rigidnonlinear_mask.mif smooth - ) $(mrfilter population_template/fa_rigidnonlinear_mask.mif.gz smooth - ) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_affinenonlinear_template.mif -type affine_nonlinear -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_affinenonlinear_mask.mif -force && testing_diff_image ../tmp/population_template/fa_affinenonlinear_template.mif population_template/fa_affinenonlinear_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_affinenonlinear_mask.mif smooth -) $(mrfilter population_template/fa_affinenonlinear_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_voxelsize_template.mif -voxel_size 4.8 -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_voxelsize_mask.mif -force && testing_diff_image ../tmp/population_template/fa_voxelsize_template.mif population_template/fa_voxelsize_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_voxelsize_mask.mif smooth -) $(mrfilter population_template/fa_voxelsize_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_initaligngeometric_template.mif -initial_alignment geometric -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_initaligngeometric_mask.mif -force && testing_diff_image ../tmp/population_template/fa_initaligngeometric_template.mif population_template/fa_initaligngeometric_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_initaligngeometric_mask.mif smooth -) $(mrfilter population_template/fa_initaligngeometric_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fa/ ../tmp/population_template/fa_initalignnone_template.mif -initial_alignment none -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fa_initalignnone_mask.mif -force && testing_diff_image ../tmp/population_template/fa_initalignnone_template.mif population_template/fa_initalignnone_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fa_initalignnone_mask.mif smooth -) $(mrfilter population_template/fa_initalignnone_mask.mif.gz smooth -) -abs 0.3
mkdir -p tmp-fod && tail -n1 BIDS/sub-02/dwi/sub-02_tissue-WM_response.txt > tmp.txt && dwi2fod csd BIDS/sub-02/dwi/sub-02_dwi.nii.gz tmp.txt -fslgrad BIDS/sub-02/dwi/sub-02_dwi.bvec BIDS/sub-02/dwi/sub-02_dwi.bval -mask BIDS/sub-02/dwi/sub-02_brainmask.nii.gz tmp-fod/sub-02.mif -lmax 4 -force && tail -n1 BIDS/sub-03/dwi/sub-03_tissue-WM_response.txt > tmp.txt && dwi2fod csd BIDS/sub-03/dwi/sub-03_dwi.nii.gz tmp.txt -fslgrad BIDS/sub-03/dwi/sub-03_dwi.bvec BIDS/sub-03/dwi/sub-03_dwi.bval -mask BIDS/sub-03/dwi/sub-03_brainmask.nii.gz tmp-fod/sub-03.mif -lmax 4 -force && population_template tmp-fod/ ../tmp/population_template/fod_default_template.mif -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fod_default_mask.mif -force && testing_diff_image ../tmp/population_template/fod_default_template.mif population_template/fod_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fod_default_mask.mif smooth -) $(mrfilter population_template/fod_mask.mif.gz smooth -) -abs 0.3
population_template tmp-fod/ ../tmp/population_template/fod_options_template.mif -mask_dir tmp-mask/ -template_mask ../tmp/population_template/fod_options_mask.mif -linear_no_pause -linear_estimator l2 -rigid_scale 0.3,0.4,0.6,0.8,1.0,1.0 -rigid_lmax 2,2,2,4,4,4 -rigid_niter 100 -affine_scale 0.3,0.4,0.6,0.8,1.0,1.0 -affine_lmax 2,2,2,4,4,4 -affine_niter 500 -nl_scale 0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0 -nl_lmax 2,2,2,2,2,2,2,2,4,4,4,4,4,4,4,4 -nl_niter 5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5 -force && testing_diff_image ../tmp/population_template/fod_options_template.mif population_template/fod_template.mif.gz -abs 0.01 && testing_diff_image $(mrfilter ../tmp/population_template/fod_options_mask.mif smooth -) $(mrfilter population_template/fod_mask.mif.gz smooth -) -abs 0.3
