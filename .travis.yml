sudo: false
dist: trusty
language: cpp
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty-5.0
    packages:
      - g++-7
      - clang-5.0
      - zlib1g-dev
      - libqt4-opengl-dev
      - python3
      - python-pip
      - python3-pip
matrix:
  include:
    #######################################################################
    # Generate documentation through Sphinx; Use both Python2 and Python3 #
    #######################################################################
    - env: py=python2 test=sphinx
    - env: py=python3 test=sphinx
    #############################################################
    # Run the check_memalign script; only needs to be done once #
    #############################################################
    - env: test=memalign
    ##############################################
    # Run PyLint tests; both Python2 and Python3 #
    ##############################################
    - env: py=python2 test=pylint
    - env: py=python3 test=pylint
    #################################################################################
    # Build binaries, run tests and check documentation: Clang, Python2 and Python3 #
    #################################################################################
    - env: CXX=clang++-5.0 py=python2 test=build
    - env: CXX=clang++-5.0 py=python3 test=build
    ################################################################
    # Test build using GCC; no need to use both versions of Python #
    ################################################################
    - env: CXX=g++-7 py=python2 test=build
install:
  - export NUMBER_OF_PROCESSORS=4
  - export PATH=`pwd`/bin:${PATH}
  - export PYTHONPATH=`pwd`/lib:${PYTHONPATH}
  - |
    if [[ "${test}" == "sphinx" ]]; then
        if [[ "${py}" == "python2" ]]; then
            pip install urllib3[secure];
            pip install --user recommonmark sphinx sphinx-rtd-theme;
        else
            pip3 install --user recommonmark sphinx sphinx-rtd-theme;
        fi
    fi
  - |
    if [[ "${test}" == "pylint" ]]; then
        if [[ "${py}" == "python2" ]]; then
            pip install --user pylint;
        else
            pip3 install --user pylint;
        fi
    fi
  - |
    if [[ "${test}" == "build" ]]; then
        export EIGEN_CFLAGS=-I`pwd`/../eigen;
        (cd ..; hg clone https://bitbucket.org/eigen/eigen/; cd eigen; hg update 3.3);
    fi
script:
  - ./travis.sh
after_failure:
  - |
    if [[ "${test}" == "sphinx" ]]; then
        cat sphinx.log;
    elif [[ "${test}" == "memalign" ]]; then
        cat memalign.log;
    elif [[ "${test}" == "pylint" ]]; then
        cat pylint.log;
    else
        cat configure.log;
        cat build.log;
        cat testing.log;
        cat gitdiff.log;
    fi
  - sleep 10
