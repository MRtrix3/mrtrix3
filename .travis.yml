language: cpp
os:
  - linux
    sudo: false
    dist: trusty
  - osx
    osx_image: xcode9.2
cache:
  apt: true
  packages: true
  directories:
    - $HOME/.cache/pip
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - llvm-toolchain-trusty-5.0
    packages:
      - g++-7
      - clang-5.0
      - zlib1g-dev
      - libqt4-opengl-dev
      - python3
      - python-pip
      - python3-pip
matrix:
  include:
    #####################################################################
    # Build binaries, run tests and check documentation: Clang, Python3 #
    # (Note: Run this one first, since it'll be the longest job)        #
    #####################################################################
    - env: TRAVIS_CXX=clang++-5.0 py=python3 test=run
    #######################################################################
    # Build binaries (without optimisation): GCC, Python2                 #
    # (Also ensures both Python 2 and 3 are tested for configure & build) #
    #######################################################################
    - env: TRAVIS_CXX=g++-7 py=python2 test=build
    #######################################################################
    # Generate documentation through Sphinx; Use both Python2 and Python3 #
    #######################################################################
    - env: py=python2 test=sphinx
    - env: py=python3 test=sphinx
    #############################################################
    # Run the check_memalign script; only needs to be done once #
    #############################################################
    - env: test=memalign
    ##############################################
    # Run PyLint tests; both Python2 and Python3 #
    ##############################################
    - env: py=python2 test=pylint
    - env: py=python3 test=pylint
before_install:
  #####################################################################################################################
  # TravisCI sets CXX based on what it thinks the compiler should be; therefore we need to set it as late as possible #
  #####################################################################################################################
  - |
    if [[ -v TRAVIS_CXX ]]; then
      export CXX=${TRAVIS_CXX}
    fi
install:
  - export NUMBER_OF_PROCESSORS=2
  - export PATH=`pwd`/bin:${PATH}
  - export PYTHONPATH=`pwd`/lib:${PYTHONPATH}
  - |
    if [[ "${test}" == "sphinx" ]]; then
        if [[ "${py}" == "python2" ]]; then
            pip install urllib3[secure];
            pip install --user recommonmark sphinx sphinx-rtd-theme;
        else
            pip3 install --user recommonmark sphinx sphinx-rtd-theme;
        fi
    fi
  - |
    if [[ "${test}" == "pylint" ]]; then
        if [[ "${py}" == "python2" ]]; then
            pip install --user pylint;
        else
            pip3 install --user pylint;
        fi
    fi
  - |
    if [[ "${test}" == "build" || "${test}" == "run" ]]; then
        export EIGEN_CFLAGS=-I`pwd`/../eigen;
        (cd ..; hg clone https://bitbucket.org/eigen/eigen/; cd eigen; hg update 3.3);
    fi
script:
  - ./travis.sh
before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log
after_failure:
  - |
    case "${test}" in
      "sphinx")
        cat sphinx.log
        ;;
      "memalign")
        cat memalign.log
        ;;
      "pylint")
        cat pylint.log
        ;;
      "build")
        cat configure.log
        cat build.log
        ;;
      *)
        cat configure.log
        cat build.log
        cat testing.log
        cat gitdiff.log
    esac
  - sleep 10
