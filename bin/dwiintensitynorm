#!/usr/bin/env python



def usage(cmdline): #pylint: disable=unused-variable
  cmdline.set_author('David Raffelt (david.raffelt@florey.edu.au)')
  cmdline.set_synopsis('Performs a global DWI intensity normalisation on a group of subjects using the median b=0 white matter value as the reference')
  cmdline.add_description('The white matter mask is estimated from a population average FA template then warped back to each subject to perform the intensity normalisation. Note that bias field correction should be performed prior to this step.')
  cmdline.add_argument('input_dir', help='The input directory containing all DWI images')
  cmdline.add_argument('mask_dir', help='Input directory containing brain masks, corresponding to one per input image (with the same file name prefix)')
  cmdline.add_argument('output_dir', help='The output directory containing all of the intensity normalised DWI images')
  cmdline.add_argument('fa_template', help='The output population specific FA template, which is threshold to estimate a white matter mask')
  cmdline.add_argument('wm_mask', help='The output white matter mask (in template space), used to estimate the median b=0 white matter value for normalisation')
  cmdline.add_argument('-fa_threshold', default='0.4', help='The threshold applied to the Fractional Anisotropy group template used to derive an approximate white matter mask (default: 0.4)')






import os

def abspath(*arg):
  return os.path.abspath(os.path.join(*arg))

def relpath(*arg):
  return os.path.relpath(os.path.join(*arg), app.WORKING_DIR)

class Input(object):
  def __init__(self, filename, prefix, directory, mask_filename = '', mask_directory = ''):
    self.filename = filename
    self.prefix = prefix
    self.directory = directory
    self.mask_filename = mask_filename
    self.mask_directory = mask_directory






def execute(): #pylint: disable=unused-variable
  from mrtrix3 import image, MRtrixError, path, run

  app.ARGS.input_dir = relpath(app.ARGS.input_dir)
  input_dir = app.ARGS.input_dir
  if not os.path.exists(input_dir):
    raise MRtrixError('input directory not found')
  in_files = path.all_in_dir(input_dir, dir_path=False)
  if len(in_files) <= 1:
    app.console('not enough images found in input directory. More than one image is needed to perform a group-wise intensity normalisation')
  else:
    app.console('performing global intensity normalisation on ' + str(len(in_files)) + ' input images')

  app.ARGS.mask_dir = relpath(app.ARGS.mask_dir)
  mask_dir = app.ARGS.mask_dir
  if not os.path.exists(mask_dir):
    raise MRtrixError('mask directory not found')
  mask_files = path.all_in_dir(mask_dir, dir_path=False)
  if len(mask_files) != len(in_files):
    raise MRtrixError('the number of images in the mask directory does not equal the number of images in the input directory')
  mask_common_postfix = os.path.commonprefix([i[::-1] for i in mask_files])[::-1]
  mask_prefixes = []
  for mask_file in mask_files:
    mask_prefixes.append(mask_file.split(mask_common_postfix)[0])

  common_postfix = os.path.commonprefix([i[::-1] for i in in_files])[::-1]
  input_list = []
  for i in in_files:
    subj_prefix = i.split(common_postfix)[0]
    if subj_prefix not in mask_prefixes:
      raise MRtrixError ('no matching mask image was found for input image ' + i)
    image.check_3d_nonunity(os.path.join(path.from_user(input_dir, False), i))
    index = mask_prefixes.index(subj_prefix)
    input_list.append(Input(i, subj_prefix, path.from_user(input_dir, False), mask_files[index], path.from_user(mask_dir, False)))

  app.check_output_path(app.ARGS.fa_template)
  app.check_output_path(app.ARGS.wm_mask)
  app.check_output_path(app.ARGS.output_dir)
  path.make_dir(app.ARGS.output_dir)

  app.make_scratch_dir()

  mask_temp_dir = os.path.join(app.SCRATCH_DIR, os.path.basename(os.path.normpath(mask_dir)))
  run.command('cp -R -L ' + mask_dir + ' ' + mask_temp_dir)

  app.goto_scratch_dir()

  path.make_dir('fa')
  progress = app.ProgressBar('Computing FA images', len(input_list))
  for i in input_list:
    run.command('dwi2tensor ' + abspath(i.directory, i.filename) + ' -mask ' + abspath(i.mask_directory, i.mask_filename) + ' - | tensor2metric - -fa ' + os.path.join('fa', i.prefix + '.mif'))
    progress.increment()
  progress.done()

  app.console('Generating FA population template')
  run.command('population_template fa -mask_dir ' + mask_temp_dir + ' fa_template.mif -type rigid_affine_nonlinear -rigid_scale 0.25,0.5,0.8,1.0 -affine_scale 0.7,0.8,1.0,1.0 -nl_scale 0.5,0.75,1.0,1.0,1.0 -nl_niter 5,5,5,5,5 -scratch population_template -linear_no_pause -nocleanup')

  app.console('Generating WM mask in template space')
  run.command('mrthreshold fa_template.mif -abs ' +  app.ARGS.fa_threshold + ' template_wm_mask.mif')

  progress = app.ProgressBar('Intensity normalising subject images', len(input_list))
  path.make_dir('wm_mask_warped')
  for i in input_list:
    run.command('mrtransform template_wm_mask.mif -interp nearest -warp_full ' + os.path.join('population_template', 'warps', i.prefix + '.mif') + ' ' + os.path.join('wm_mask_warped', i.prefix + '.mif') + ' -from 2 -template ' + os.path.join('fa', i.prefix + '.mif'))
    run.command('dwinormalise ' + abspath(i.directory, i.filename) + ' ' + os.path.join('wm_mask_warped', i.prefix + '.mif') + ' ' + path.from_user(os.path.join(app.ARGS.output_dir, i.filename)) + app.mrconvert_output_option(path.from_user(os.path.join(input_dir, i.filename))))
    progress.increment()
  progress.done()

  app.console('Exporting template images to user locations')
  run.command('mrconvert template_wm_mask.mif ' + path.from_user(app.ARGS.wm_mask) + app.mrconvert_output_option('NULL'))
  run.command('mrconvert fa_template.mif ' + path.from_user(app.ARGS.fa_template) + app.mrconvert_output_option('NULL'))






# Make the corresponding MRtrix3 Python libraries available
import inspect, sys
LIB_FOLDER = os.path.realpath(os.path.join(os.path.dirname(os.path.realpath(inspect.getfile(inspect.currentframe()))), os.pardir, 'lib'))
if not os.path.isdir(LIB_FOLDER):
  sys.stderr.write('Unable to locate MRtrix3 Python libraries')
  sys.exit(1)
sys.path.insert(0, LIB_FOLDER)
# Execute the script
from mrtrix3 import app
app.execute()
